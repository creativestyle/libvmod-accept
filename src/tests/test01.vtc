varnishtest "Test accept vmod"

server s1 {
       rxreq
       txresp
       expect req.http.tst == "foo"

       rxreq
       txresp
       expect req.http.tst == "bar"

       rxreq
       txresp
       expect req.http.tst == "baz"

       rxreq
       txresp
       expect req.http.tst == "bar"

       rxreq
       txresp
       expect req.http.tst == "bar"

       rxreq
       txresp
       expect req.http.tst == "bar"

} -start

varnish v1 -vcl+backend {
	import ${vmod_accept};

	sub vcl_init {
		new rule = accept.rule("foo");
		rule.add("bar");
		rule.add("baz");
	}

	sub vcl_recv {
		set req.http.tst = rule.filter(req.http.tst);
		return (pass);
	}
} -start

client c1 {
	txreq -hdr "tst: foo"
	rxresp

	txreq -hdr "tst: bar"
	rxresp

	txreq -hdr "tst: baz"
	rxresp

	txreq -hdr "tst: qux;q=1  level=15,bar;baz"
	rxresp

	txreq -hdr "tst: baza; baz    ,  bar, baz"
	rxresp

	txreq -hdr "tst: this. is; a-tricky/one , but,   bar  , is)what$we want"
	rxresp
} -run
